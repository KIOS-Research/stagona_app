<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shower Challenge</title>
    <link href="https://fonts.googleapis.com/css2?family=Concert+One&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
         :root {
            --primary: #0066cc;
            --accent: #ffca28;
            --danger: #e53935;
            --bg-gradient: linear-gradient(135deg, #e0f7fa 0%, #80deea 100%);
            --font: 'Segoe UI', sans-serif;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 1rem;
            font-family: var(--font);
            background: var(--bg-gradient);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        
        .container {
            width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, .1);
            position: relative;
        }
        
        .header {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .header img {
            height: 60px;
            width: auto;
            object-fit: contain;
        }
        
        .language-toggle {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.3s;
        }
        
        .language-toggle:hover {
            background: #004a99;
        }
        
        h1 {
            color: var(--primary);
            text-align: center;
            margin-bottom: 2rem;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 2.5rem;
            font-weight: 600;
        }
        
        .question {
            margin-bottom: 1rem;
        }
        
        label {
            display: block;
            margin-bottom: .5rem;
            font-weight: 500;
        }
        
        input[type=range],
        input[type=number] {
            width: 100%;
            margin-bottom: .5rem;
        }
        
        input[type=number] {
            padding: .5rem;
            border: 1px solid #ccc;
            border-radius: 8px;
            outline: none;
        }
        
        input[type=range] {
            -webkit-appearance: none;
            height: 8px;
            background: #ddd;
            border-radius: 4px;
            outline: none;
            cursor: pointer;
            margin: 0;
        }
        
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
            margin-top: -4px;
        }
        
        .slider-value {
            text-align: right;
            font-size: 1rem;
            color: var(--primary);
            margin-top: -.5rem;
            margin-bottom: 1rem;
        }
        
        .btn {
            display: block;
            width: 100%;
            padding: .8rem;
            background: var(--primary);
            color: #fff;
            font-size: 1rem;
            font-weight: 500;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background .3s, transform .2s;
            box-shadow: 0 2px 6px rgba(0, 0, 0, .15);
            margin-bottom: 1rem;
        }
        
        .btn:hover {
            background: #004a99;
            transform: translateY(-2px);
        }
        
        .results {
            display: none;
            margin-top: 1rem;
        }
        
        .gauges {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .gauge {
            background: #fff;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 6px rgba(0, 0, 0, .1);
        }
        
        .gauge.served {
            background: var(--primary);
            color: white;
        }
        
        .gauge.served .gauge-bar {
            background: var(--accent);
        }
        
        .gauge.served small {
            color: rgba(255, 255, 255, 0.8);
        }
        
        .gauge-bar {
            height: 16px;
            background: var(--primary);
            border-radius: 8px;
            transition: width .5s;
            margin-bottom: .5rem;
        }
        
        .badge-container {
            text-align: center;
            margin-bottom: 1rem;
        }
        
        .badge {
            display: inline-block;
            background: var(--accent);
            color: #333;
            padding: .5rem 1rem;
            border-radius: 12px;
            margin: .25rem;
            font-weight: 500;
            box-shadow: 0 2px 6px rgba(0, 0, 0, .1);
        }
        
        .box {
            background: #f9f9f9;
            border-left: 4px solid var(--primary);
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 4px;
            font-size: 1.1rem;
            line-height: 1.4;
        }
        
        .box.alert {
            border-color: var(--danger);
        }
        
        .box.success {
            border-color: var(--accent);
        }
        
        .hero-header {
            background: var(--primary);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            text-align: center;
            font-size: 1.5rem;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .input-section {
            transition: opacity 0.3s, transform 0.3s;
        }
        
        .input-section.hidden {
            display: none;
        }
        
        .response-section {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }
        
        .response-section.visible {
            display: block;
        }
        
        .gauges {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .gauge {
            background: #fff;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 6px rgba(0, 0, 0, .1);
        }
        
        .gauge-bar {
            height: 16px;
            background: var(--primary);
            border-radius: 8px;
            transition: width .5s;
            margin-bottom: .5rem;
        }
        
        .badge-container {
            text-align: center;
            margin-bottom: 1rem;
        }
        
        .badge {
            display: inline-block;
            background: var(--accent);
            color: #333;
            padding: .5rem 1rem;
            border-radius: 12px;
            margin: .25rem;
            font-weight: 500;
            box-shadow: 0 2px 6px rgba(0, 0, 0, .1);
        }
        
        .btn.refresh {
            background: var(--accent);
            color: #333;
            margin-top: 2rem;
        }
        
        .btn.refresh:hover {
            background: #e6b800;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .footer {
            text-align: center;
            margin-top: 2rem;
            padding: 1rem;
            color: #666;
            font-size: 0.9rem;
        }
        
        .footer a {
            color: var(--primary);
            text-decoration: none;
        }
        
        .footer a:hover {
            text-decoration: underline;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 2rem;
            width: 80%;
            max-width: 800px;
            border-radius: 12px;
            position: relative;
        }
        
        .close-modal {
            position: absolute;
            right: 1rem;
            top: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        
        .close-modal:hover {
            color: var(--primary);
        }
        
        .chart-container {
            margin: 2rem 0;
            height: 300px;
        }
        
        .stats-btn {
            background: var(--accent);
            color: #333;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 1rem;
            transition: background-color 0.3s;
        }
        
        .stats-btn:hover {
            background: #e6b800;
        }
        
        .data-links {
            text-align: center;
            margin-top: 1rem;
            padding: 1rem;
        }
        
        .data-links a {
            color: var(--primary);
            text-decoration: none;
            margin: 0 1rem;
            font-size: 0.9rem;
        }
        
        .data-links a:hover {
            text-decoration: underline;
        }
        
        .data-links a.delete {
            color: var(--danger);
        }
        
        .chart-section {
            background: #fff;
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, .1);
        }
        
        .chart-section h2 {
            color: var(--primary);
            text-align: center;
            margin-bottom: 2rem;
            font-size: 1.8rem;
        }
        
        .chart-container {
            margin: 2rem 0;
            height: 300px;
            background: #fff;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, .05);
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <img src="ucy_logo.png" alt="UCY Logo">
            <img src="kios_logo.png" alt="KIOS Logo">
        </div>
        <button class="language-toggle" id="languageToggle">Ελληνικά</button>
        <h1 id="title">Shower Challenge</h1>
        <div class="input-section" id="inputSection">
            <div class="question">
                <label for="showerMin" id="showerLabel"></label>
                <input type="range" id="showerMin" min="0" max="20" step="1" value="0">
                <div class="slider-value"><span id="showerVal">0</span> <span id="minutesText">min</span></div>
            </div>
            <div class="question">
                <label for="guessLiters" id="guessLabel">How many liters of water do you think you use in your house per day?</label>
                <input type="range" id="guessLiters" min="0" max="300" step="10" value="0">
                <div class="slider-value"><span id="guessVal">0</span> <span id="litersText">L</span></div>
            </div>
            <button class="btn" id="getScoreBtn">Get Your Score!</button>
        </div>

        <div class="response-section" id="responseSection">
            <div class="box" id="showerBox"></div>
            <div class="box" id="consumptionBox"></div>
            <div class="box" id="promptBox"></div>
        </div>

        <div class="results" id="results">
            <div class="hero-header" id="heroHeader">Be a hero by saving water!</div>
            <div class="question">
                <label for="exploreMin" id="exploreLabel">Adjust your shower length:</label>
                <input type="range" id="exploreMin" min="0" max="20" step="1" value="11" disabled>
                <div class="slider-value"><span id="exploreVal">11</span> <span id="exploreMinutesText">min</span></div>
            </div>
            <div class="gauges" id="gaugesSection">
                <div class="gauge">
                    <div id="personalLabel">Personal<br><small id="personalUnit">(Liters)</small></div>
                    <div class="gauge-bar" id="personalBar" style="width:0%;"></div>
                    <div id="personalVal">0 L</div>
                </div>
                <div class="gauge">
                    <div id="percentLabel">Total Daily Usage<br><small id="percentUnit">(Shower + Other)</small></div>
                    <div class="gauge-bar" id="percentBar" style="width:0%;"></div>
                    <div id="percentVal">0 L</div>
                </div>
                <div class="gauge served">
                    <div id="servedLabel">Additional Population Served</div>
                    <div class="gauge-bar" id="servedBar" style="width:0%;"></div>
                    <div id="peopleServedVal">0</div>
                </div>
            </div>
            <div class="badge-container" id="badges"></div>

            <div class="chart-section">
                <h2 id="statsTitle">Water Usage Statistics</h2>
                <div class="chart-container">
                    <canvas id="showerHistogram"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="consumptionHistogram"></canvas>
                </div>
            </div>

            <button class="btn refresh" id="refreshBtn" onclick="window.location.reload()">Start Over</button>
        </div>

    </div>

    <div class="footer">
        Created by
        <a href="https://www.kios.ucy.ac.cy/eliades" target="_blank">Demetrios Eliades</a>. Copyright (C)
        <a href="https://www.kios.ucy.ac.cy" target="_blank">KIOS Research and Innovation Center of Excellence</a>,
        <a href="https://www.ucy.ac.cy" target="_blank">University of Cyprus</a>
    </div>

    <div class="data-links">
        <a href="#" id="downloadData">Download Statistics (CSV)</a>
        <a href="#" id="clearData" class="delete">Clear All Data</a>
    </div>

    <script>
        const RATE = 9,
            POP = 1000000,
            AVERAGE = 140,
            BASE_SHOWER = AVERAGE * 0.65;

        const translations = {
            en: {
                title: "Shower Challenge",
                heroHeader: "Be a hero by saving water!",
                showerLabel: "How many minutes do you think you spend in the shower every day?",
                guessLabel: "How many liters of water do you think you use in your house every day?",
                getScoreBtn: "How you compare with the average Cypriot?",
                minutes: "min",
                liters: "L",
                exploreLabel: "Adjust your shower length:",
                personalLabel: "Shower usage",
                personalUnit: "(Liters)",
                percentLabel: "Total Daily Usage",
                percentUnit: "(Shower + Other)",
                servedLabel: "Additional poplulation",
                servedUnit: "(people with more water)",
                refreshBtn: "Start Over",
                languageToggle: "Ελληνικά",
                showerBox: (mins, usage, percentage) =>
                    `You said your shower for ${mins} minutes, which is  ${usage} liters. An average shower in Cyprus is 9 minutes, or 90 liters. Showering is more than half or out daily water usage.`,
                consumptionBox: (guess) =>
                    `You think you use ${guess} liters of water every day. The average in Cyprus is 140 liters.`,
                promptBox: (mins) => {
                    if (mins <= 5) return "Great job! You are a water hero - keep it up!";
                    if (mins <= 10) return "Nice work! Try cutting a few minutes from your shower!";
                    return "You seem to be taking long showers. Try shortening your shower by a few minutes.";
                },
                badges: {
                    waterMinder: "Water Minder",
                    megaWaterSaver: "Mega Water Saver"
                },
                downloadData: "Download Statistics (CSV)",
                clearData: "Clear All Data",
                confirmClear: "Are you sure you want to delete all statistics? This action cannot be undone.",
                noData: "No data available to download.",
                dataCleared: "All statistics have been cleared.",
                statsTitle: "Water Usage Statistics",
                showerHistogramTitle: "Shower Duration Distribution",
                consumptionHistogramTitle: "Estimated Daily Water Consumption Distribution",
                viewStatsBtn: "View Statistics",
                minutesLabel: "Minutes",
                litersLabel: "Liters",
                responsesLabel: "Number of Responses"
            },
            el: {
                title: "Πρόκληση Ντους",
                heroHeader: "Γίνετε ήρωας εξοικονομώντας νερό!",
                showerLabel: "Πόσα λεπτά περνάτε κάθε μέρα στο ντους;",
                guessLabel: "Πόσα λίτρα νερού νομίζετε ότι χρησιμοποιείτε στο σπίτι σας την ημέρα;",
                getScoreBtn: "Πώς συγκρίνεστε με τον μέσο Κύπριο;",
                minutes: "λεπ",
                liters: "Λ",
                exploreLabel: "Προσαρμόστε τη διάρκεια του ντους σας:",
                personalLabel: "Χρήση ντους",
                personalUnit: "(Λίτρα)",
                percentLabel: "Συνολική Ημερήσια Κατανάλωση",
                percentUnit: "(Ντους + Άλλες Χρήσεις)",
                servedLabel: "Επιπλέον Πληθυσμός που Εξυπηρετείται",
                servedUnit: "(άτομα με περισσότερο νερό)",
                refreshBtn: "Ξεκινήστε Ξανά",
                languageToggle: "English",
                showerBox: (mins, usage, percentage) =>
                    `Είπατε ότι κάνετε ντους για ${mins} λεπτά, που αντιστοιχεί σε ${usage} λίτρα. Ο μέσος χρόνος ντους στην Κύπρο είναι 9 λεπτά, ή 90 λίτρα. Το ντους αποτελεί περισσότερο από το μισό της ημερήσιας κατανάλωσης νερού.`,
                consumptionBox: (guess) =>
                    `Νομίζετε ότι χρησιμοποιείτε ${guess} λίτρα νερού την ημέρα. Ο μέσος όρος στην Κύπρο είναι 140 λίτρα.`,
                promptBox: (mins) => {
                    if (mins <= 5) return "Μπράβο! Είστε ήρωας του νερού - συνεχίστε έτσι!";
                    if (mins <= 10) return "Καλή δουλειά! Προσπαθήστε να μειώσετε μερικά λεπτά από το ντους σας!";
                    return "Φαίνεται να κάνετε μεγάλα ντους. Προσπαθήστε να μειώσετε τη διάρκεια του ντους σας κατά μερικά λεπτά.";
                },
                badges: {
                    waterMinder: "Φύλακας Νερού",
                    megaWaterSaver: "Μεγάλος Εξοικονομητής Νερού"
                },
                downloadData: "Λήψη Στατιστικών (CSV)",
                clearData: "Διαγραφή Όλων των Δεδομένων",
                confirmClear: "Είστε βέβαιοι ότι θέλετε να διαγράψετε όλα τα στατιστικά; Αυτή η ενέργεια δεν μπορεί να αναιρεθεί.",
                noData: "Δεν υπάρχουν διαθέσιμα δεδομένα για λήψη.",
                dataCleared: "Όλα τα στατιστικά έχουν διαγραφεί.",
                statsTitle: "Στατιστικά Κατανάλωσης Νερού",
                showerHistogramTitle: "Κατανομή Διάρκειας Ντους",
                consumptionHistogramTitle: "Κατανομή Εκτιμώμενης Ημερήσιας Κατανάλωσης Νερού",
                viewStatsBtn: "Προβολή Στατιστικών",
                minutesLabel: "Λεπτά",
                litersLabel: "Λίτρα",
                responsesLabel: "Αριθμός Απαντήσεων"
            }
        };

        let currentLang = 'en';

        function updateLanguage() {
            const t = translations[currentLang];
            document.getElementById('title').textContent = t.title;
            document.getElementById('heroHeader').textContent = t.heroHeader;
            document.getElementById('showerLabel').textContent = t.showerLabel;
            document.getElementById('guessLabel').textContent = t.guessLabel;
            document.getElementById('getScoreBtn').textContent = t.getScoreBtn;
            document.getElementById('minutesText').textContent = t.minutes;
            document.getElementById('litersText').textContent = t.liters;
            document.getElementById('exploreLabel').textContent = t.exploreLabel;
            document.getElementById('exploreMinutesText').textContent = t.minutes;
            document.getElementById('personalLabel').innerHTML = t.personalLabel + '<br><small>' + t.personalUnit + '</small>';
            document.getElementById('percentLabel').innerHTML = t.percentLabel + '<br><small>' + t.percentUnit + '</small>';
            document.getElementById('servedLabel').textContent = t.servedLabel;
            document.getElementById('refreshBtn').textContent = t.refreshBtn;
            document.getElementById('languageToggle').textContent = t.languageToggle;
            document.getElementById('downloadData').textContent = t.downloadData;
            document.getElementById('clearData').textContent = t.clearData;
            document.getElementById('statsTitle').textContent = t.statsTitle;

            // Update response boxes if they exist
            if (showerBox.textContent) {
                const mins = +showerMin.value;
                const usage = mins * RATE;
                const guess = +guessLiters.value;
                const showerPercentage = Math.round((usage / AVERAGE) * 100);

                showerBox.textContent = t.showerBox(mins, usage, showerPercentage);
                consumptionBox.textContent = t.consumptionBox(guess);
                promptBox.textContent = t.promptBox(mins);
            }

            // Update badges if they exist
            if (badgesDiv.innerHTML) {
                const mins = +exploreMin.value;
                badgesDiv.innerHTML = '';
                if (mins <= 7 && mins > 3) badgesDiv.innerHTML += `<div class="badge">${t.badges.waterMinder}</div>`;
                if (mins <= 3) badgesDiv.innerHTML += `<div class="badge">${t.badges.megaWaterSaver}</div>`;
            }
        }

        // Function to get random integer between min and max (inclusive)
        function getRandomInt(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        // Function to get random value in steps
        function getRandomStep(min, max, step) {
            const steps = Math.floor((max - min) / step);
            return min + (getRandomInt(0, steps) * step);
        }

        const showerMin = document.getElementById('showerMin'),
            showerVal = document.getElementById('showerVal'),
            guessLiters = document.getElementById('guessLiters'),
            guessVal = document.getElementById('guessVal'),
            getScoreBtn = document.getElementById('getScoreBtn'),
            resultsDiv = document.getElementById('results'),
            personalBar = document.getElementById('personalBar'),
            percentBar = document.getElementById('percentBar'),
            servedBar = document.getElementById('servedBar'),
            personalVal = document.getElementById('personalVal'),
            percentVal = document.getElementById('percentVal'),
            peopleServedVal = document.getElementById('peopleServedVal'),
            badgesDiv = document.getElementById('badges'),
            showerBox = document.getElementById('showerBox'),
            consumptionBox = document.getElementById('consumptionBox'),
            promptBox = document.getElementById('promptBox'),
            exploreMin = document.getElementById('exploreMin'),
            exploreVal = document.getElementById('exploreVal'),
            inputSection = document.getElementById('inputSection'),
            responseSection = document.getElementById('responseSection'),
            languageToggle = document.getElementById('languageToggle');

        function updateAll(mins) {
            const personalUsage = mins * RATE;
            const otherUsage = AVERAGE * 0.35; // 35% of daily average (non-shower usage)
            const totalUsage = personalUsage + otherUsage;
            const percent = Math.round(totalUsage / AVERAGE * 100);
            const savedPerPerson = Math.max(BASE_SHOWER - personalUsage, 0);
            const totalSaved = savedPerPerson * POP;
            const peopleServed = Math.floor(totalSaved / AVERAGE);

            // gauges
            personalBar.style.width = Math.min(personalUsage / AVERAGE * 100, 100) + '%';
            personalVal.textContent = personalUsage + ' ' + translations[currentLang].liters;
            percentBar.style.width = Math.min(percent, 100) + '%';
            percentVal.textContent = totalUsage + ' ' + translations[currentLang].liters;
            const servedPct = Math.min(peopleServed / POP * 100, 100);
            servedBar.style.width = servedPct + '%';
            peopleServedVal.textContent = peopleServed.toLocaleString();

            // badges
            badgesDiv.innerHTML = '';
            if (mins <= 7 && mins > 3) badgesDiv.innerHTML += `<div class="badge">${translations[currentLang].badges.waterMinder}</div>`;
            if (mins <= 3) badgesDiv.innerHTML += `<div class="badge">${translations[currentLang].badges.megaWaterSaver}</div>`;
        }

        // Initialize data storage
        let responses = JSON.parse(localStorage.getItem('showerResponses') || '[]');

        // Function to store response
        function storeResponse(showerMinutes, consumptionGuess) {
            responses.push({
                showerMinutes: parseInt(showerMinutes),
                consumptionGuess: parseInt(consumptionGuess),
                timestamp: new Date().toISOString()
            });
            localStorage.setItem('showerResponses', JSON.stringify(responses));
        }

        // Function to create histogram data
        function createHistogramData(data, min, max, step, fixedBins = false) {
            const bins = {};
            const numBins = 10;

            if (fixedBins) {
                // For consumption data (0-300 liters)
                const binSize = 30; // 300/10 = 30 liters per bin
                for (let i = 0; i < 300; i += binSize) {
                    bins[i] = 0;
                }
                data.forEach(value => {
                    const bin = Math.floor(value / binSize) * binSize;
                    if (bin in bins) {
                        bins[bin]++;
                    }
                });
            } else {
                // For shower duration (0-20 minutes)
                const binSize = 2; // 20/10 = 2 minutes per bin
                for (let i = 0; i < 20; i += binSize) {
                    bins[i] = 0;
                }
                data.forEach(value => {
                    const bin = Math.floor(value / binSize) * binSize;
                    if (bin in bins) {
                        bins[bin]++;
                    }
                });
            }
            return bins;
        }

        // Function to create histogram
        function createHistogram(canvasId, data, userValue, title, xLabel, fixedBins = false) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const bins = createHistogramData(data, 0, Math.max(...data), 1, fixedBins);

            // Calculate the bin for the user's value
            const binSize = fixedBins ? 30 : 2;
            const userBin = Math.floor(userValue / binSize) * binSize;

            const datasets = [{
                label: translations[currentLang].responsesLabel,
                data: Object.values(bins),
                backgroundColor: Object.keys(bins).map(bin => {
                    const binValue = parseInt(bin);
                    return binValue === userBin ? 'rgba(255, 0, 0, 0.7)' : 'rgba(0, 102, 204, 0.7)';
                }),
                borderColor: 'rgba(0, 102, 204, 1)',
                borderWidth: 1
            }];

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(bins).map(bin => {
                        const binValue = parseInt(bin);
                        const nextBin = binValue + (fixedBins ? 29 : 1);
                        return `${binValue}-${nextBin}`;
                    }),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: title
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const binValue = parseInt(context.label.split('-')[0]);
                                    const isUserBin = binValue === userBin;
                                    return [
                                        `${translations[currentLang].responsesLabel}: ${context.raw}`,
                                        isUserBin ? '(Your value)' : ''
                                    ].filter(Boolean);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: translations[currentLang].responsesLabel
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: xLabel
                            }
                        }
                    }
                }
            });
        }

        // Event Listeners
        getScoreBtn.addEventListener('click', () => {
            // Store the response
            storeResponse(showerMin.value, guessLiters.value);

            // Hide input section and show response section
            inputSection.classList.add('hidden');
            responseSection.classList.add('visible');

            // Calculate values
            const mins = +showerMin.value;
            const usage = mins * RATE;
            const guess = +guessLiters.value;
            const showerPercentage = Math.round((usage / AVERAGE) * 100);

            // Update response boxes
            showerBox.textContent = translations[currentLang].showerBox(mins, usage, showerPercentage);
            consumptionBox.textContent = translations[currentLang].consumptionBox(guess);
            promptBox.textContent = translations[currentLang].promptBox(mins);

            // Update gauges
            updateAll(mins);

            // Enable explore slider and set its initial value
            exploreMin.disabled = false;
            exploreMin.value = mins;
            exploreVal.textContent = mins;
            resultsDiv.style.display = 'block';

            // Create histograms
            const showerData = responses.map(r => r.showerMinutes);
            const consumptionData = responses.map(r => r.consumptionGuess);
            const currentShower = parseInt(showerMin.value);
            const currentConsumption = parseInt(guessLiters.value);

            // Destroy existing charts if they exist
            const showerChart = Chart.getChart('showerHistogram');
            const consumptionChart = Chart.getChart('consumptionHistogram');
            if (showerChart) showerChart.destroy();
            if (consumptionChart) consumptionChart.destroy();

            // Create new histograms
            createHistogram('showerHistogram', showerData, currentShower,
                translations[currentLang].showerHistogramTitle, translations[currentLang].minutesLabel);
            createHistogram('consumptionHistogram', consumptionData, currentConsumption,
                translations[currentLang].consumptionHistogramTitle, translations[currentLang].litersLabel, true);
        });

        exploreMin.addEventListener('input', () => {
            const mins = +exploreMin.value;
            exploreVal.textContent = mins;
            updateAll(mins);
        });

        showerMin.addEventListener('input', () => {
            showerVal.textContent = showerMin.value;
        });

        guessLiters.addEventListener('input', () => {
            guessVal.textContent = guessLiters.value;
        });

        languageToggle.addEventListener('click', () => {
            currentLang = currentLang === 'en' ? 'el' : 'en';
            updateLanguage();
        });

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            // Set random initial values
            const randomMinutes = getRandomInt(0, 20);
            const randomLiters = getRandomStep(0, 300, 10);

            showerMin.value = randomMinutes;
            showerVal.textContent = randomMinutes;

            guessLiters.value = randomLiters;
            guessVal.textContent = randomLiters;

            // Initialize language
            updateLanguage();
        });

        // Function to download data as CSV
        function downloadCSV() {
            const headers = ['Timestamp', 'Shower Minutes', 'Consumption Guess (Liters)'];
            const csvContent = [
                headers.join(','),
                ...responses.map(r => [
                    r.timestamp,
                    r.showerMinutes,
                    r.consumptionGuess
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], {
                type: 'text/csv;charset=utf-8;'
            });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `shower_statistics_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Function to clear all data
        function clearData() {
            if (confirm('Are you sure you want to delete all statistics? This action cannot be undone.')) {
                responses = [];
                localStorage.removeItem('showerResponses');
                alert('All statistics have been cleared.');
            }
        }

        // Add event listeners for the new links
        document.getElementById('downloadData').addEventListener('click', (e) => {
            e.preventDefault();
            if (responses.length === 0) {
                alert('No data available to download.');
                return;
            }
            downloadCSV();
        });

        document.getElementById('clearData').addEventListener('click', (e) => {
            e.preventDefault();
            clearData();
        });
    </script>
</body>

</html>