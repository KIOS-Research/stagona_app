<!DOCTYPE html>
<html lang="el">

<head>
    <meta charset="UTF-8" />
    <link rel="manifest" href="manifest/site.webmanifest" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Stagona">
    <title data-el="app-title"></title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playpen+Sans:wght@400&display=swap" rel="stylesheet">
    <!-- Font Awesome via CDNJS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="css/style.css" />
    <link rel="apple-touch-icon" sizes="180x180" href="public/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="public/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="public/favicon-16x16.png" />
    <script src="js/translations.js"></script>
    <script defer src="js/sw.js"></script>
</head>

<body>
    <div id="installSnackbar" class="install-snackbar" hidden>
        <span id="installSnackbarText"></span>
        <button id="installSnackbarBtn"></button>
    </div>
    <div class="container">
        <div class="app-header">
            <i class="lang-toggle" id="langToggle" title="English"></i>
            <img src="assets/images/logo.png" alt="Stagona Water Consumption Calculator Logo" class="app-logo" />
            <i class="fas fa-info-circle info-icon" id="infoButton" title="About"></i>
        </div>
        <h2 data-el="title"></h2>
        <h3 class="subtitle">
            <span data-el="intro-question"></span>
        </h3>
        <div class="jump-link-container" style="text-align:center; margin-bottom:1.25rem;">
            <a href="#instructions" class="jump-link"><span data-el="jump-link-btn"></span> <i class="fas fa-arrow-down"></i></a>
        </div>
        <div id="scarcityBanner" class="scarcity-banner">
            <span data-el="scarcity-msg"></span>
            <i class="fas fa-info-circle info-icon info-icon-orange" id="stressInfo"></i>
        </div>
        <div id="whyBanner" class="why-banner">
            <span data-el="why-msg"></span>
        </div>
        <div id="actionBanner" class="action-banner">
            <span data-el="action-msg"></span>
            <i class="fas fa-info-circle info-icon info-icon-green" id="actionInfo"></i>
        </div>
        <div class="section-separator">
            <i class="fas fa-cog"></i>
        </div>
        <div>
            <div class="input-group-bordered">
                <div class="instructions-text" id="instructions">
                    <span data-el="intro-instructions"></span>
                    <div class="how-it-works-image">
                        <img src="assets/images/howitworks.png" alt="How the Stagona water consumption calculator works">
                    </div>
                </div>

                <label for="total"><span data-el="total-label"></span><a href="#" class="example-link" data-el="example-link"></a></label>
                <input type="number" id="total" data-el="total-placeholder" min="0" step="0.1" max="500" />
                <label for="period" data-el="period-label"></label>
                <select id="period" required>
            <option value="" disabled selected data-el="period-select"></option>
            <option value="1" data-el="period-1"></option>
            <option value="2" data-el="period-2"></option>
            <option value="3" data-el="period-3"></option>
            <option value="4" data-el="period-4"></option>
         </select>
                <label for="people" data-el="people-label"></label>
                <input type="number" id="people" data-el="people-placeholder" min="1" step="1" max="15" />
                <button id="calc"><strong>‚öôÔ∏è<span data-el="calc-button" ></span></strong></button>
            </div>

        </div>


        <div id="result" style="display:none;">
            <div id="bluebox">
                <div class="result-box">
                    <p class="result-value">--</p>
                    <p class="result-label" data-el="result-title"></p>
                    <div class="gauge-track">
                        <div class="gauge-fill" id="gaugeBar"></div>
                    </div>
                </div>
                <div class="result-box">
                    <p class="result-diff">--</p>
                    <p class="result-diff-label" data-el="result-diff"></p>
                </div>
                <div class="result-box">
                    <div id="resultMessage"></div>
                </div>
            </div>
            <div class="section-separator">
                <i class="fas fa-hashtag"></i>
            </div>
            <h2>#Cyprus125</h2>
            <div style="text-align: center; width: 100%;">
                <strong class="pledge-title" data-el="share-title"></strong>
            </div>
            <p id="pledge-subtitle" data-el="pledge-subtitle"></p>
            <div class="pledge-slider-section result-box">
                <label for="pledgeSlider" id="pledgeSliderLabel"></label>
                <input type="range" id="pledgeSlider" min="0" max="50" step="5" value="10" />
            </div>
            <div id="bluebox">
                <div id="resultSummary"></div>
                <div id="bannerImage">
                    <canvas id="bannerCanvas" style="width: 100%; max-width: 600px; height: auto; display: block; margin: 0 auto;"></canvas>
                    <button id="downloadBanner" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #0066cc; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9rem;">
                        üì• Download
                    </button>
                </div>
                <div class="share-section">
                    <div class="share-buttons">
                        <div class="share-button" id="shareTwitter" title="Twitter"><i class="fab fa-twitter"></i></div>
                        <div class="share-button" id="shareFacebook" title="Facebook"><i class="fab fa-facebook"></i></div>
                        <div class="share-button" id="shareInstagram" title="Instagram"><i class="fab fa-instagram"></i></div>
                        <div class="share-button" id="shareWhatsApp" title="WhatsApp"><i class="fab fa-whatsapp"></i></div>
                        <div class="share-button" id="shareViber" title="Viber"><i class="fab fa-viber"></i></div>
                        <div class="share-button" id="shareEmail" title="Email"><i class="fas fa-envelope"></i></div>
                        <div class="share-button" id="copySummary" title="Copy message"><i class="fas fa-clipboard"></i></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section-separator">
            <i class="fas fa-cog"></i>
        </div>
        <button id="tipsButton" type="button" class="tips-button">üí° <span data-el="tips-title"></span></button>
        <button id="reminderButton" type="button" class="reminder-button">üìÖ <span data-el="reminder-title"></span></button>
        <p class="privacy-notice">
            <span data-el="contact-info-prefix"></span>
            <a href="#" id="contactEmail" class="email-link">kios-dwic@ucy.onmicrosoft.com</a>
        </p>
        <p class="privacy-notice">
            <a href="https://github.com/KIOS-Research/stagona_app/blob/main/privacy_policy.md" target="_blank" class="privacy-link">Privacy Policy:</a> <span data-el="privacy-notice"></span>
        </p>
    </div>
    <!-- Example Modal -->
    <div class="example-modal" id="exampleModal">
        <div class="example-modal-content">
            <i class="fas fa-times example-modal-close" id="exampleModalClose"></i>
            <h3 data-el="help-title"></h3>
            <img src="assets/images/eoanicosia.png" alt="Example water bill from EOA Nicosia showing consumption data" class="example-image">
            <p data-el="help-explanation"></p>
        </div>
    </div>
    <!-- Notice Modal -->
    <div class="notice-modal" id="noticeModal">
        <div class="notice-modal-content">
            <i class="fas fa-times notice-modal-close" id="noticeModalClose"></i>
            <div class="notice-modal-message" id="noticeModalMessage"></div>
            <button class="notice-modal-button" id="noticeModalButton">OK</button>
        </div>
    </div>
    <!-- Footer -->
    <div class="footer">
        <a href="https://www.kios.ucy.ac.cy/eliades" target="_blank">Smart Water Systems Team</a
            >, <a href="https://www.kios.ucy.ac.cy" target="_blank"
            >KIOS Research and Innovation Center of Excellence</a
            >, <a href="https://www.ucy.ac.cy" target="_blank">University of Cyprus. </a> <br>Copyright ¬© 2025 KIOS CoE, UCY. All rights reserved.<br>
        <span id="footerVersion"></span>
    </div>
    <!-- About Modal -->
    <div class="modal" id="aboutModal">
        <div class="modal-content">
            <i class="fas fa-times modal-close" id="modalClose"></i>
            <div class="modal-logos">
                <img src="assets/images/ucy_logo.png" alt="University of Cyprus Logo" class="modal-logo" />
                <img src="assets/images/kios_logo.png" alt="KIOS Research and Innovation Center of Excellence Logo" class="modal-logo" />
            </div>
            <div class="modal-section">
                <h3 data-el="about-title"></h3>
                <p data-el="about-desc"></p>
            </div>
            <div class="modal-section">
                <h3 data-el="how-to-title"></h3>
                <p data-el="how-to-1"></p>
                <p data-el="how-to-2"></p>
                <p data-el="how-to-3"></p>
                <p data-el="how-to-4"></p>
                <p data-el="how-to-5"></p>
            </div>
            <div class="modal-section">
                <h3 data-el="privacy-title"></h3>
                <span data-el="privacy-desc"></span> (<a href="https://github.com/KIOS-Research/stagona_app/blob/main/privacy_policy.md" target="_blank" class="privacy-link">Privacy Policy</a>)
            </div>
            <div class="modal-section">
                <h3 data-el="version-title"></h3>
                <p data-el="version-number"></p>
            </div>
        </div>
    </div>
    <!-- Tips Modal -->
    <div class="modal" id="tipsModal">
        <div class="modal-content">
            <i class="fas fa-times modal-close" id="tipsModalClose"></i>
            <div class="modal-section">
                <h3 data-el="tips-title"></h3>
                <p data-el="tip-1"></p>
                <p data-el="tip-2"></p>
                <p data-el="tip-3"></p>
                <p data-el="tip-4"></p>
                <p data-el="tip-5"></p>
                <p data-el="tip-6"></p>
                <p data-el="tip-7"></p>
                <p data-el="tip-8"></p>
                <p data-el="tip-9"></p>
                <p data-el="tip-10"></p>
                <p data-el="tip-11"></p>
            </div>
            <div class="modal-section">
                <h3 data-el="tips-parents-title"></h3>
                <p data-el="tip-parent-1"></p>
                <p data-el="tip-parent-2"></p>
                <p data-el="tip-parent-3"></p>
            </div>
        </div>
    </div>
    <!-- Water Stress Info Modal -->
    <div class="modal" id="stressInfoModal">
        <div class="modal-content">
            <i class="fas fa-times modal-close" id="stressInfoModalClose"></i>
            <div class="modal-section">
                <h3 data-el="stress-info-title"></h3>
                <p data-el="stress-info-1"></p>
                <p data-el="stress-info-2"></p>
                <p data-el="stress-info-3"></p>
                <p data-el="stress-info-4a"></p>
                <p data-el="stress-info-4b"></p>
                <p data-el="stress-info-5a"></p>
                <p data-el="stress-info-5b"></p>
            </div>
        </div>
    </div>
    <!-- Action Info Modal -->
    <div class="modal" id="actionInfoModal">
        <div class="modal-content">
            <i class="fas fa-times modal-close" id="actionInfoModalClose"></i>
            <div class="modal-section">
                <h3 data-el="action-info-title"></h3>
                <p data-el="action-info-1"></p>
                <p data-el="action-info-2"></p>
                <p data-el="action-info-3"></p>
                <p data-el="action-info-4"></p>
                <p data-el="action-info-5"></p>
            </div>
        </div>
    </div>
    <!-- Why Info Modal -->
    <div class="modal" id="whyInfoModal">
        <div class="modal-content">
            <i class="fas fa-times modal-close" id="whyInfoModalClose"></i>
            <div class="modal-section">
                <h3 data-el="why-info-title"></h3>
                <p data-el="why-info-1"></p>
                <p data-el="why-info-2"></p>
                <p data-el="why-info-3"></p>
                <p data-el="why-info-4"></p>
                <p data-el="why-info-5"></p>
                <p data-el="why-info-6"></p>
            </div>
        </div>
    </div>

    <!-- Hidden template image for banner generation -->
    <img id="bannerTemplate" src="assets/images/banner.jpg" style="display: none;">

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Utility functions (from utility.js)
            function containsHtmlTags(str) {
                return /<[^>]*>/g.test(str);
            }

            function updateElementContent(element, content) {
                if (containsHtmlTags(content)) {
                    element.innerHTML = content;
                } else {
                    element.textContent = content;
                }
            }

            // PWA Install functionality (from main.js)
            let deferredPrompt;
            const snackbar = document.getElementById('installSnackbar');
            const snackbarBtn = document.getElementById('installSnackbarBtn');
            const snackbarText = document.getElementById('installSnackbarText');

            function isIos() {
                return /iphone|ipad|ipod/i.test(window.navigator.userAgent);
            }

            function isInStandaloneMode() {
                return ('standalone' in window.navigator) && window.navigator.standalone;
            }

            window.addEventListener('beforeinstallprompt', e => {
                if (isIos()) return;
                e.preventDefault();
                deferredPrompt = e;
                showInstallSnackbar();
            });

            function showInstallSnackbar() {
                if (isIos() && !isInStandaloneMode()) {
                    snackbarText.textContent = "To install, tap the Share button ‚Üë and then 'Add to Home Screen'.";
                    snackbarBtn.style.display = 'none';
                    snackbar.hidden = false;
                    setTimeout(() => snackbar.classList.add('show'), 50);
                    setTimeout(hideInstallSnackbar, 8000);
                    return;
                }
                if (!deferredPrompt) return;
                snackbarText.textContent = 'Install Stagona App?';
                snackbarBtn.textContent = 'Install';
                snackbarBtn.style.display = '';
                snackbar.hidden = false;
                setTimeout(() => snackbar.classList.add('show'), 50);
                setTimeout(hideInstallSnackbar, 8000);
            }

            function hideInstallSnackbar() {
                snackbar.classList.remove('show');
                setTimeout(() => {
                    snackbar.hidden = true;
                }, 400);
            }

            snackbarBtn.addEventListener('click', async() => {
                if (!deferredPrompt) return;
                deferredPrompt.prompt();
                await deferredPrompt.userChoice;
                deferredPrompt = null;
                hideInstallSnackbar();
            });

            window.addEventListener('appinstalled', () => {
                hideInstallSnackbar();
            });

            window.addEventListener('load', () => {
                if (isIos() && !isInStandaloneMode()) {
                    showInstallSnackbar();
                }
            });

            // Main application code
            let currentLang = "el";

            // DRY: Unified summary generator
            function generateSummary({
                lang = "el",
                perDay,
                diffPct,
                avg = 140,
                url = "https://stagona.cy",
                pledge = 0,
                pledgeLiters = null,
                mode = "share" // or "quote"
            }) {
                // Compose difference string
                let diffStr;
                if (lang === "el") {
                    diffStr = diffPct < 0 ? `${Math.abs(diffPct).toFixed(1)}% Œ∫Œ¨œÑœâ Œ±œÄœå ŒºŒ≠œÉŒø œåœÅŒø œÑœâŒΩ 140 ŒªŒØœÑœÅœâŒΩ/Œ∑ŒºŒ≠œÅŒ±` : `${diffPct.toFixed(1)}% œÄŒ¨ŒΩœâ Œ±œÄœå ŒºŒ≠œÉŒø œåœÅŒø œÑœâŒΩ 140 ŒªŒØœÑœÅœâŒΩ/Œ∑ŒºŒ≠œÅŒ±`;
                } else {
                    diffStr = diffPct < 0 ? `${Math.abs(diffPct).toFixed(1)}% below average of 140 liters/day` : `${diffPct.toFixed(1)}% above average of 140 liters/day`;
                }
                // Compose base
                let summary;
                if (lang === "el") {
                    if (mode === "share") {
                        summary = `ŒúœåŒªŒπœÇ œÖœÄŒøŒªœåŒ≥ŒπœÉŒ± œÑŒ∑ŒΩ Œ±œÑŒøŒºŒπŒ∫ŒÆ Œ∫Œ±œÑŒ±ŒΩŒ¨ŒªœâœÉŒÆ ŒΩŒµœÅŒøœç ŒºŒøœÖ: ${perDay.toFixed(1)} ŒªŒØœÑœÅŒ±/Œ∑ŒºŒ≠œÅŒ± (${diffStr}).`;
                        if (pledge > 0 && pledgeLiters !== null) {
                            summary += ` ŒòŒ± œÄœÅŒøœÉœÄŒ±Œ∏ŒÆœÉœâ ŒΩŒ± œÑŒ∑ ŒºŒµŒπœéœÉœâ Œ∫Œ±œÑŒ¨ ${pledge}% (${pledgeLiters} ŒªŒØœÑœÅŒ±/Œ∑ŒºŒ≠œÅŒ±) ŒºŒ≠œÉŒ± œÉœÑŒøŒΩ ŒµœÄœåŒºŒµŒΩŒø ŒºŒÆŒΩŒ±. #Cyprus125`;
                        }
                        summary += ` ŒîŒøŒ∫ŒØŒºŒ±œÉŒ≠ œÑŒø Œ∫Œ±Œπ ŒµœÉœç: ${url}`;
                    } else {
                        summary = `ŒúœåŒªŒπœÇ œÖœÄŒøŒªœåŒ≥ŒπœÉŒ± œÑŒ∑ŒΩ Œ±œÑŒøŒºŒπŒ∫ŒÆ Œ∫Œ±œÑŒ±ŒΩŒ¨ŒªœâœÉŒÆ ŒΩŒµœÅŒøœç ŒºŒøœÖ: ${perDay.toFixed(1)} ŒªŒØœÑœÅŒ±/Œ∑ŒºŒ≠œÅŒ± (${diffStr}).`;
                        if (pledge > 0 && pledgeLiters !== null) {
                            summary += ` ŒòŒ± œÄœÅŒøœÉœÄŒ±Œ∏ŒÆœÉœâ ŒΩŒ± œÑŒ∑ ŒºŒµŒπœéœÉœâ Œ∫Œ±œÑŒ¨ ${pledge}% (${pledgeLiters} ŒªŒØœÑœÅŒ±/Œ∑ŒºŒ≠œÅŒ±) ŒºŒ≠œÉŒ± œÉœÑŒøŒΩ ŒµœÄœåŒºŒµŒΩŒø ŒºŒÆŒΩŒ±. #Cyprus125`;
                        }
                        summary += ` ŒîŒøŒ∫ŒØŒºŒ±œÉŒ≠ œÑŒø Œ∫Œ±Œπ ŒµœÉœç: ${url}`;
                    }
                } else {
                    if (mode === "share") {
                        summary = `I've just calculated my individual water consumption: ${perDay.toFixed(1)} liters/day (${diffStr}).`;
                        if (pledge > 0 && pledgeLiters !== null) {
                            summary += ` I will try to reduce it by ${pledge}% (${pledgeLiters} liters/day) in the next month. #Cyprus125`;
                        }
                        summary += ` Try it yourself: ${url}`;
                    } else {
                        summary = `I've just calculated my individual water consumption: ${perDay.toFixed(1)} liters/day (${diffStr}).`;
                        if (pledge > 0 && pledgeLiters !== null) {
                            summary += ` I will try to reduce it by ${pledge}% (${pledgeLiters} liters/day) in the next month. #Cyprus125`;
                        }
                        summary += ` Try it yourself: ${url}`;
                    }
                }
                return summary;
            }

            // Replace createSummary
            function createSummary(perDay, diffPct, avg, url, lang) {
                // Get pledge info
                let pledge = 0;
                let pledgeLiters = null;
                const slider = document.getElementById("pledgeSlider");
                if (slider) {
                    pledge = parseInt(slider.value, 10) || 0;
                    pledgeLiters = (perDay * (1 - pledge / 100)).toFixed(1);
                }
                return generateSummary({
                    lang,
                    perDay,
                    diffPct,
                    avg,
                    url,
                    pledge,
                    pledgeLiters,
                    mode: "share"
                });
            }

            // Replace updateResultSummary
            function updateResultSummary() {
                // Get values
                let perDay = 140;
                let diffPct = 0;
                const totalM3 = parseFloat(document.getElementById("total").value);
                const months = parseInt(document.getElementById("period").value);
                const people = parseInt(document.getElementById("people").value);
                if (totalM3 > 0 && months > 0 && people > 0) {
                    const totalLitres = totalM3 * 1000;
                    const days = months * 30.4;
                    perDay = totalLitres / days / people;
                    diffPct = ((perDay - 140) / 140) * 100;
                }
                // Pledge
                let pledge = 0;
                let pledgeLiters = null;
                const pledgeSlider = document.getElementById("pledgeSlider");
                if (pledgeSlider) {
                    pledge = parseInt(pledgeSlider.value, 10) || 0;
                    pledgeLiters = (perDay * (1 - pledge / 100)).toFixed(1);
                }
                // Compose using unified generator
                const summary = generateSummary({
                    lang: currentLang,
                    perDay,
                    diffPct,
                    avg: 140,
                    url: "https://stagona.cy",
                    pledge,
                    pledgeLiters,
                    mode: "quote"
                });
                document.getElementById("resultSummary").innerHTML = summary;

                // Regenerate banner if result is visible
                const result = document.getElementById("result");
                if (result && result.style.display !== "none" && !result.hasAttribute("hidden")) {
                    generateBanner(perDay, diffPct);
                }
            }

            // Function to update text content
            function updateLanguage(lang) {
                const elements = document.querySelectorAll("[data-el]");
                elements.forEach((element) => {
                    const key = element.getAttribute("data-el");
                    if (translations[lang][key]) {
                        const translation = translations[lang][key];

                        if (element.tagName === "INPUT" || element.tagName === "SELECT") {
                            element.placeholder = translation;
                        } else {
                            updateElementContent(element, translation);

                            // Update title attribute for elements that have it
                            if (element.hasAttribute("title")) {
                                element.title = translation;
                            }
                        }
                    }
                });
                document.getElementById("langToggle").textContent =
                    lang === "el" ? "English" : "ŒïŒªŒªŒ∑ŒΩŒπŒ∫Œ¨";
                document.getElementById("langToggle").title =
                    lang === "el" ? "English" : "ŒïŒªŒªŒ∑ŒΩŒπŒ∫Œ¨";
                currentLang = lang;

                // Update footer version number
                const footerVersion = document.getElementById("footerVersion");
                if (footerVersion) {
                    footerVersion.textContent = `${translations[lang]["version-title"]}: ${translations[lang]["version-number"]}`;
                }

                // Always update result labels regardless of visibility - use more specific selectors
                const resultContainer = document.getElementById("result");
                const wasHidden = resultContainer && resultContainer.style.display === "none";

                // Temporarily show result if it's hidden to ensure elements are accessible
                if (wasHidden && resultContainer) {
                    resultContainer.style.display = "block";
                }

                const resultLabel = document.querySelector('p.result-label[data-el="result-title"]');
                if (resultLabel && translations[lang]["result-title"]) {
                    resultLabel.textContent = translations[lang]["result-title"];
                    // Add brief highlight to show the change
                    resultLabel.style.backgroundColor = "#ffffcc";
                    setTimeout(() => {
                        resultLabel.style.backgroundColor = "";
                    }, 500);
                }

                const resultDiffLabel = document.querySelector('p.result-diff-label[data-el="result-diff"]');
                if (resultDiffLabel && translations[lang]["result-diff"]) {
                    resultDiffLabel.textContent = translations[lang]["result-diff"];
                    // Add brief highlight to show the change
                    resultDiffLabel.style.backgroundColor = "#ffffcc";
                    setTimeout(() => {
                        resultDiffLabel.style.backgroundColor = "";
                    }, 500);
                }

                // Hide result again if it was hidden before
                if (wasHidden && resultContainer) {
                    resultContainer.style.display = "none";
                }

                // Update "liters" text and "below/above average" text if result exists
                const valueElem = document.querySelector(".result-value");
                if (valueElem && valueElem.textContent !== "--") {
                    // Extract the number from the current text
                    const match = valueElem.textContent.match(/([\d.]+)/);
                    if (match) {
                        const number = match[1];
                        valueElem.textContent = number + (lang === "el" ? " ŒªŒØœÑœÅŒ±" : " liters");
                    }
                }

                const diffElem = document.querySelector(".result-diff");
                if (diffElem && diffElem.textContent !== "--") {
                    // Extract the percentage from the current text
                    const match = diffElem.textContent.match(/([\d.]+)%/);
                    if (match) {
                        const percentage = match[1];
                        // Check if it's below or above average by looking for "below" or "above" in current text
                        const isBelow = diffElem.textContent.includes("below") || diffElem.textContent.includes("Œ∫Œ¨œÑœâ");
                        diffElem.innerHTML = isBelow ?
                            `${percentage}%<br>${translations[lang]["result-below"]}` :
                            `${percentage}%<br>${translations[lang]["result-above"]}`;
                    }
                }

                // Update pledge slider label if result is visible
                const pledgeSlider = document.getElementById("pledgeSlider");
                if (pledgeSlider) {
                    updatePledgeLabel();
                }

                // Update result message if result exists
                updateResultMessage();

                // Regenerate banner if result is visible and calculation has been made
                const result = document.getElementById("result");
                if (result && result.style.display !== "none" && !result.hasAttribute("hidden")) {
                    // Get current calculation values if they exist
                    const totalM3 = parseFloat(document.getElementById("total").value);
                    const months = parseInt(document.getElementById("period").value);
                    const people = parseInt(document.getElementById("people").value);

                    if (totalM3 > 0 && months > 0 && people > 0) {
                        const totalLitres = totalM3 * 1000;
                        const days = months * 30.4;
                        const perDay = totalLitres / days / people;
                        const diffPct = ((perDay - 140) / 140) * 100;
                        generateBanner(perDay, diffPct);
                    }
                }
            }

            // Language toggle button click handler
            document.getElementById("langToggle").addEventListener("click", () => {
                const newLang = currentLang === "el" ? "en" : "el";
                updateLanguage(newLang);
            });

            // Ensure all translations are set on page load
            updateLanguage(currentLang);

            document.getElementById("calc").addEventListener("click", () => {
                const totalM3 = parseFloat(document.getElementById("total").value);
                const months = parseInt(document.getElementById("period").value);
                const people = parseInt(document.getElementById("people").value);
                const avg = 140;

                if (totalM3 <= 0) {
                    showNotice(translations[currentLang]["negative-consumption"]);
                    return;
                }
                if (people <= 0) {
                    showNotice(translations[currentLang]["negative-people"]);
                    return;
                }
                if (totalM3 > 500) {
                    showNotice(currentLang === 'el' ? 'Œó ŒºŒ≠Œ≥ŒπœÉœÑŒ∑ Œ±œÄŒøŒ¥ŒµŒ∫œÑŒÆ œÑŒπŒºŒÆ ŒµŒØŒΩŒ±Œπ 500 m¬≥.' : 'Maximum allowed value is 500 m¬≥.');
                    document.getElementById("total").value = 500;
                    document.getElementById("total").focus();
                    return;
                }
                if (people > 15) {
                    showNotice(currentLang === 'el' ? 'Œü ŒºŒ≠Œ≥ŒπœÉœÑŒøœÇ Œ±œÅŒπŒ∏ŒºœåœÇ Œ±œÑœåŒºœâŒΩ ŒµŒØŒΩŒ±Œπ 15.' : 'Maximum number of people is 15.');
                    document.getElementById("people").value = 15;
                    document.getElementById("people").focus();
                    return;
                }
                if (!totalM3) {
                    document.getElementById("total").focus();
                    return;
                }
                if (!months) {
                    document.getElementById("period").focus();
                    return;
                }
                if (!people) {
                    document.getElementById("people").focus();
                    return;
                }

                // Calculate values
                const totalLitres = totalM3 * 1000;
                const days = months * 30.4;
                const perDay = totalLitres / days / people;
                const diffPct = ((perDay - avg) / avg) * 100;

                // Show the result area
                const result = document.getElementById("result");
                result.style.removeProperty("display");
                result.removeAttribute("hidden");

                // Update static fields
                const valueElem = result.querySelector(".result-value");
                if (valueElem) valueElem.textContent = perDay.toFixed(1) + (currentLang === "el" ? " ŒªŒØœÑœÅŒ±" : " liters");

                const diffElem = result.querySelector(".result-diff");
                if (diffElem) diffElem.innerHTML = (perDay < avg ?
                    `${Math.abs(diffPct).toFixed(1)}%<br>${translations[currentLang]["result-below"]}` :
                    `${diffPct.toFixed(1)}%<br>${translations[currentLang]["result-above"]}`);

                // Update gauge
                const bar = document.getElementById("gaugeBar");
                if (bar) {
                    const percentage = Math.min(100, Math.max(0, ((perDay - 70) / (210 - 70)) * 100));
                    bar.style.width = percentage + "%";
                    if (percentage <= 50) {
                        const greenToOrange = percentage / 50;
                        const red = Math.round(76 + (greenToOrange * 127));
                        const green = Math.round(175 - (greenToOrange * 87));
                        const blue = Math.round(80 - (greenToOrange * 80));
                        bar.style.background = `rgb(${red}, ${green}, ${blue})`;
                    } else {
                        const orangeToRed = (percentage - 50) / 50;
                        const red = Math.round(203 + (orangeToRed * 52));
                        const green = Math.round(88 - (orangeToRed * 88));
                        bar.style.background = `rgb(${red}, ${green}, 0)`;
                    }
                }

                // Update result message
                const msgElem = document.getElementById("resultMessage");
                if (msgElem) {
                    let msg = "";
                    if (diffPct < -20) {
                        msg = translations[currentLang]["result-excellent"] + "<br/><br/>" + translations[currentLang]["result-excellent-desc"];
                    } else if (diffPct >= -20 && diffPct < -10) {
                        msg = translations[currentLang]["result-good"] + "<br/><br/>" + translations[currentLang]["result-good-desc"];
                    } else if (diffPct >= -10 && diffPct < 0) {
                        msg = translations[currentLang]["result-average"] + "<br/><br/>" + translations[currentLang]["result-average-desc"];
                    } else if (diffPct >= 0 && diffPct < 10) {
                        msg = translations[currentLang]["result-slightly-high"] + "<br/><br/>" + translations[currentLang]["result-slightly-high-desc"];
                    } else if (diffPct >= 10 && diffPct < 20) {
                        msg = translations[currentLang]["result-high"] + "<br/><br/>" + translations[currentLang]["result-high-desc"];
                    } else {
                        msg = translations[currentLang]["result-very-high"] + "<br/><br/>" + translations[currentLang]["result-very-high-desc"];
                    }
                    msgElem.innerHTML = msg;
                }

                // Update summary
                updateResultSummary();
                // Connect slider
                const pledgeSlider = document.getElementById("pledgeSlider");
                if (pledgeSlider) {
                    pledgeSlider.oninput = updateResultSummary;
                }

                // Attach share button event listeners
                const url = "https://stagona.cy";

                function getCurrentSummary() {
                    return createSummary(perDay, diffPct, avg, url, currentLang);
                }
                const shareTwitter = document.getElementById("shareTwitter");
                if (shareTwitter) shareTwitter.onclick = () => {
                    // Download the banner image first
                    const canvas = document.getElementById('bannerCanvas');
                    const link = document.createElement('a');
                    link.download = 'stagona-banner.png';
                    link.href = canvas.toDataURL('image/png');
                    link.click();

                    // Copy message to clipboard and show info
                    const message = getCurrentSummary();
                    navigator.clipboard.writeText(message).then(() => {
                        const modalMessage = currentLang === 'el' ?
                            '‚úÖ Œó ŒµŒπŒ∫œåŒΩŒ± Œ∫Œ±œÑŒ≠Œ≤Œ∑Œ∫Œµ!\nüìã Œ§Œø ŒºŒÆŒΩœÖŒºŒ± Œ±ŒΩœÑŒπŒ≥œÅŒ¨œÜŒ∑Œ∫Œµ!\n\nŒ§œéœÅŒ± Œ±ŒΩŒøŒØŒ≥ŒµŒπ œÑŒø X/Twitter Œ≥ŒπŒ± ŒΩŒ± ŒºŒøŒπœÅŒ±œÉœÑŒµŒØœÑŒµ œÑŒ∑ŒΩ ŒµŒπŒ∫œåŒΩŒ± Œ∫Œ±Œπ œÑŒø ŒºŒÆŒΩœÖŒºŒ±.' :
                            '‚úÖ Image downloaded!\nüìã Message copied to clipboard!\n\nNow opening X/Twitter to share the image and message.';

                        showNotice(modalMessage);

                        // Open Twitter after a short delay
                        setTimeout(() => {
                            const enc = encodeURIComponent(message);
                            window.open(`https://twitter.com/intent/tweet?text=${enc}`, "_blank");
                        }, 1000);
                    }).catch(err => {
                        console.error('Failed to copy message:', err);
                        showNotice(currentLang === 'el' ?
                            'Œó ŒµŒπŒ∫œåŒΩŒ± Œ∫Œ±œÑŒ≠Œ≤Œ∑Œ∫Œµ! ŒëœÄŒøœÑœÖœáŒØŒ± Œ±ŒΩœÑŒπŒ≥œÅŒ±œÜŒÆœÇ ŒºŒ∑ŒΩœçŒºŒ±œÑŒøœÇ.' :
                            'Image downloaded! Failed to copy message.');
                    });
                };
                const shareFacebook = document.getElementById("shareFacebook");
                if (shareFacebook) shareFacebook.onclick = () => {
                    const enc = encodeURIComponent(getCurrentSummary());
                    window.open(
                        `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}&quote=${enc}`,
                        "_blank"
                    );
                };
                const shareWhatsApp = document.getElementById("shareWhatsApp");
                if (shareWhatsApp) shareWhatsApp.onclick = () => {
                    // Download the banner image first
                    const canvas = document.getElementById('bannerCanvas');
                    const link = document.createElement('a');
                    link.download = 'stagona-banner.png';
                    link.href = canvas.toDataURL('image/png');
                    link.click();

                    // Copy message to clipboard and show info
                    const message = getCurrentSummary();
                    navigator.clipboard.writeText(message).then(() => {
                        const modalMessage = currentLang === 'el' ?
                            '‚úÖ Œó ŒµŒπŒ∫œåŒΩŒ± Œ∫Œ±œÑŒ≠Œ≤Œ∑Œ∫Œµ!\nüìã Œ§Œø ŒºŒÆŒΩœÖŒºŒ± Œ±ŒΩœÑŒπŒ≥œÅŒ¨œÜŒ∑Œ∫Œµ!\n\nŒ§œéœÅŒ± Œ±ŒΩŒøŒØŒ≥ŒµŒπ œÑŒø WhatsApp Œ≥ŒπŒ± ŒΩŒ± ŒºŒøŒπœÅŒ±œÉœÑŒµŒØœÑŒµ œÑŒ∑ŒΩ ŒµŒπŒ∫œåŒΩŒ± Œ∫Œ±Œπ œÑŒø ŒºŒÆŒΩœÖŒºŒ±.' :
                            '‚úÖ Image downloaded!\nüìã Message copied to clipboard!\n\nNow opening WhatsApp to share the image and message.';

                        showNotice(modalMessage);

                        // Open WhatsApp after a short delay
                        setTimeout(() => {
                            const enc = encodeURIComponent(message);
                            window.open(`https://wa.me/?text=${enc}`, "_blank");
                        }, 1000);
                    }).catch(err => {
                        console.error('Failed to copy message:', err);
                        showNotice(currentLang === 'el' ?
                            'Œó ŒµŒπŒ∫œåŒΩŒ± Œ∫Œ±œÑŒ≠Œ≤Œ∑Œ∫Œµ! ŒëœÄŒøœÑœÖœáŒØŒ± Œ±ŒΩœÑŒπŒ≥œÅŒ±œÜŒÆœÇ ŒºŒ∑ŒΩœçŒºŒ±œÑŒøœÇ.' :
                            'Image downloaded! Failed to copy message.');
                    });
                };
                const shareViber = document.getElementById("shareViber");
                if (shareViber) shareViber.onclick = () => {
                    // Download the banner image first
                    const canvas = document.getElementById('bannerCanvas');
                    const link = document.createElement('a');
                    link.download = 'stagona-banner.png';
                    link.href = canvas.toDataURL('image/png');
                    link.click();

                    // Copy message to clipboard and show info
                    const message = getCurrentSummary();
                    navigator.clipboard.writeText(message).then(() => {
                        const modalMessage = currentLang === 'el' ?
                            '‚úÖ Œó ŒµŒπŒ∫œåŒΩŒ± Œ∫Œ±œÑŒ≠Œ≤Œ∑Œ∫Œµ!\nüìã Œ§Œø ŒºŒÆŒΩœÖŒºŒ± Œ±ŒΩœÑŒπŒ≥œÅŒ¨œÜŒ∑Œ∫Œµ!\n\nŒ§œéœÅŒ± Œ±ŒΩŒøŒØŒ≥ŒµŒπ œÑŒø Viber Œ≥ŒπŒ± ŒΩŒ± ŒºŒøŒπœÅŒ±œÉœÑŒµŒØœÑŒµ œÑŒ∑ŒΩ ŒµŒπŒ∫œåŒΩŒ± Œ∫Œ±Œπ œÑŒø ŒºŒÆŒΩœÖŒºŒ±.' :
                            '‚úÖ Image downloaded!\nüìã Message copied to clipboard!\n\nNow opening Viber to share the image and message.';

                        showNotice(modalMessage);

                        // Open Viber after a short delay
                        setTimeout(() => {
                            const enc = encodeURIComponent(message);
                            window.open(`viber://forward?text=${enc}`, "_blank");
                        }, 1000);
                    }).catch(err => {
                        console.error('Failed to copy message:', err);
                        showNotice(currentLang === 'el' ?
                            'Œó ŒµŒπŒ∫œåŒΩŒ± Œ∫Œ±œÑŒ≠Œ≤Œ∑Œ∫Œµ! ŒëœÄŒøœÑœÖœáŒØŒ± Œ±ŒΩœÑŒπŒ≥œÅŒ±œÜŒÆœÇ ŒºŒ∑ŒΩœçŒºŒ±œÑŒøœÇ.' :
                            'Image downloaded! Failed to copy message.');
                    });
                };
                const shareEmail = document.getElementById("shareEmail");
                if (shareEmail) shareEmail.onclick = () => {
                    try {
                        // Download the banner image first
                        const canvas = document.getElementById('bannerCanvas');
                        const link = document.createElement('a');
                        link.download = 'stagona-banner.png';
                        link.href = canvas.toDataURL('image/png');
                        link.click();

                        // Copy message to clipboard and show info
                        const message = getCurrentSummary();
                        navigator.clipboard.writeText(message).then(() => {
                            const modalMessage = currentLang === 'el' ?
                                '‚úÖ Œó ŒµŒπŒ∫œåŒΩŒ± Œ∫Œ±œÑŒ≠Œ≤Œ∑Œ∫Œµ!\nüìã Œ§Œø ŒºŒÆŒΩœÖŒºŒ± Œ±ŒΩœÑŒπŒ≥œÅŒ¨œÜŒ∑Œ∫Œµ!\n\nŒ§œéœÅŒ± Œ±ŒΩŒøŒØŒ≥ŒµŒπ œÑŒø email client Œ≥ŒπŒ± ŒΩŒ± ŒºŒøŒπœÅŒ±œÉœÑŒµŒØœÑŒµ œÑŒ∑ŒΩ ŒµŒπŒ∫œåŒΩŒ± Œ∫Œ±Œπ œÑŒø ŒºŒÆŒΩœÖŒºŒ±.' :
                                '‚úÖ Image downloaded!\nüìã Message copied to clipboard!\n\nNow opening email client to share the image and message.';

                            showNotice(modalMessage);

                            // Open email after a short delay
                            setTimeout(() => {
                                const enc = encodeURIComponent(message);
                                const subject = currentLang === "el" ? "ŒöŒ±œÑŒ±ŒΩŒ¨ŒªœâœÉŒ∑ ŒΩŒµœÅŒøœç" : "Water Consumption";
                                const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${enc}`;
                                window.open(mailtoLink, "_blank");
                            }, 1000);
                        }).catch(err => {
                            console.error('Failed to copy message:', err);
                            showNotice(currentLang === 'el' ?
                                'Œó ŒµŒπŒ∫œåŒΩŒ± Œ∫Œ±œÑŒ≠Œ≤Œ∑Œ∫Œµ! ŒëœÄŒøœÑœÖœáŒØŒ± Œ±ŒΩœÑŒπŒ≥œÅŒ±œÜŒÆœÇ ŒºŒ∑ŒΩœçŒºŒ±œÑŒøœÇ.' :
                                'Image downloaded! Failed to copy message.');
                        });
                    } catch (err) {
                        showNotice(currentLang === "el" ? "ŒëœÄŒøœÑœÖœáŒØŒ± Œ±ŒΩŒøŒØŒ≥ŒºŒ±œÑŒøœÇ email" : "Failed to open email client");
                    }
                };
                const shareInstagram = document.getElementById("shareInstagram");
                if (shareInstagram) shareInstagram.onclick = () => {
                    // Download the banner image
                    const canvas = document.getElementById('bannerCanvas');
                    const link = document.createElement('a');
                    link.download = 'stagona-banner.png';
                    link.href = canvas.toDataURL('image/png');
                    link.click();

                    // Copy message to clipboard
                    const message = getCurrentSummary();
                    navigator.clipboard.writeText(message).then(() => {
                        // Show informational modal
                        const modalMessage = currentLang === 'el' ?
                            '‚úÖ Œó ŒµŒπŒ∫œåŒΩŒ± Œ∫Œ±œÑŒ≠Œ≤Œ∑Œ∫Œµ!\nüìã Œ§Œø ŒºŒÆŒΩœÖŒºŒ± Œ±ŒΩœÑŒπŒ≥œÅŒ¨œÜŒ∑Œ∫Œµ!\n\nŒ§œéœÅŒ± Œ±ŒΩŒøŒØŒ≥ŒµŒπ œÑŒø Instagram Œ≥ŒπŒ± ŒΩŒ± ŒºŒøŒπœÅŒ±œÉœÑŒµŒØœÑŒµ œÑŒ∑ŒΩ ŒµŒπŒ∫œåŒΩŒ± Œ∫Œ±Œπ œÑŒø ŒºŒÆŒΩœÖŒºŒ±.' :
                            '‚úÖ Image downloaded!\nüìã Message copied to clipboard!\n\nNow opening Instagram to share the image and message.';

                        showNotice(modalMessage);

                        // Open Instagram after a short delay
                        setTimeout(() => {
                            window.open('https://instagram.com', '_blank');
                        }, 1000);
                    }).catch(err => {
                        console.error('Failed to copy message:', err);
                        showNotice(currentLang === 'el' ?
                            'Œó ŒµŒπŒ∫œåŒΩŒ± Œ∫Œ±œÑŒ≠Œ≤Œ∑Œ∫Œµ! ŒëœÄŒøœÑœÖœáŒØŒ± Œ±ŒΩœÑŒπŒ≥œÅŒ±œÜŒÆœÇ ŒºŒ∑ŒΩœçŒºŒ±œÑŒøœÇ.' :
                            'Image downloaded! Failed to copy message.');
                    });
                };
                const copySummary = document.getElementById("copySummary");
                if (copySummary) copySummary.onclick = () => {
                    navigator.clipboard
                        .writeText(getCurrentSummary())
                        .then(() => showNotice(translations[currentLang]["copy-success"]));
                };

                // Generate dynamic banner
                generateBanner(perDay, diffPct);
            });

            // Banner generation function
            function generateBanner(perDay, diffPct) {
                const template = document.getElementById('bannerTemplate');
                const canvas = document.getElementById('bannerCanvas');
                const ctx = canvas.getContext('2d');

                // Helper function to wrap a single paragraph to maxWidth
                function wrapLines(ctx, paragraph, maxWidth) {
                    const words = paragraph.split(/\s+/);
                    const lines = [];
                    let line = '';

                    words.forEach((w, i) => {
                        const test = line + w + ' ';
                        if (ctx.measureText(test).width > maxWidth && i) {
                            lines.push(line.trim());
                            line = w + ' ';
                        } else {
                            line = test;
                        }
                    });
                    lines.push(line.trim());
                    return lines;
                }

                // Function to actually draw the banner
                function drawBanner() {
                    // console.log('[drawBanner] Drawing banner...');
                    // console.log('[drawBanner] ctx.font:', ctx.font);
                    // console.log('[drawBanner] template.naturalWidth:', template.naturalWidth, 'template.naturalHeight:', template.naturalHeight);
                    // Match canvas to template
                    canvas.width = template.naturalWidth;
                    canvas.height = template.naturalHeight;

                    // Clear and draw template
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(template, 0, 0);

                    // Try both font family syntaxes
                    function tryFont(fontString) {
                        ctx.fillStyle = '#003366';
                        ctx.font = fontString;
                        ctx.textAlign = 'left';
                        // console.log('[drawBanner] Set ctx.font to:', ctx.font);
                        // if ('fonts' in document) {
                        //     document.fonts.ready.then(fontFaceSet => {
                        //         const loaded = Array.from(fontFaceSet).some(ff => ff.family.replace(/['\"]/g, '').includes('Playpen Sans'));
                        //         console.log('[drawBanner] Playpen Sans loaded:', loaded, '| ctx.font:', ctx.font);
                        //     });
                        // }
                        const boxWidth = canvas.width * 0.50;
                        const lineHeight = 70;
                        const startY = canvas.height * 0.22;
                        const centerX = canvas.width / 2 * 0.35;
                        const pledgeValue = document.getElementById('pledgeSlider').value;
                        const avg = 140;
                        const diffPct = ((perDay - avg) / avg) * 100;
                        let quote;
                        if (pledgeValue == 0) {
                            quote = currentLang === 'el' ?
                                `ŒöŒ±œÑŒ±ŒΩŒ±ŒªœéŒΩœâ ${perDay.toFixed(1)} ŒªŒØœÑœÅŒ± Œ±ŒΩŒ¨ Œ∑ŒºŒ≠œÅŒ± (${Math.abs(diffPct).toFixed(1)}% ${diffPct < 0 ? 'Œ∫Œ¨œÑœâ' : 'œÄŒ¨ŒΩœâ'} Œ±œÄœå ŒºŒ≠œÉŒø œåœÅŒø œÑœâŒΩ 140).\nŒúŒ¨Œ∏Œµ Œ∫Œπ ŒµœÉœç, Œ∫Œ±Œπ Œ≥ŒØŒΩŒµ ŒºŒ≠œÅŒøœÇ œÑŒ∑œÇ ŒªœçœÉŒ∑œÇ!` :
                                `Œô consume ${perDay.toFixed(1)} liters per day (${Math.abs(diffPct).toFixed(1)}% ${diffPct < 0 ? 'below' : 'above'} the average of 140).\nLearn how much water you use, and be part of the solution!`;
                        } else {
                            quote = currentLang === 'el' ?
                                `ŒòŒ± ŒºŒµŒπœéœÉœâ Œ∫Œ±œÑŒ¨ ${pledgeValue}% œÑŒ∑ œáœÅŒÆœÉŒ∑ ŒΩŒµœÅŒøœç œÉœÑŒø œÉœÄŒØœÑŒπ ŒºŒøœÖ, Œ±œÄœå ${perDay.toFixed(0)} ŒªŒØœÑœÅŒ± Œ±ŒΩŒ¨ Œ∑ŒºŒ≠œÅŒ±.\nŒïŒØŒºŒ±Œπ ŒºŒ≠œÅŒøœÇ œÑŒ∑œÇ ŒªœçœÉŒ∑œÇ!` :
                                `I will reduce by ${pledgeValue}% my water consumption, from ${perDay.toFixed(0)} Liters per day.\nI am part of the solution!`;
                        }
                        const paragraphs = quote.split('\n');
                        let y = startY;
                        paragraphs.forEach(p => {
                            const lines = wrapLines(ctx, p, boxWidth);
                            lines.forEach(l => {
                                ctx.fillText(l, centerX, y);
                                y += lineHeight;
                            });
                            y += lineHeight * 0.3;
                        });
                    }
                    // Try with and without quotes
                    tryFont('56px "Playpen Sans", Georgia');
                    setTimeout(() => {
                        tryFont('56px Playpen Sans, Georgia');
                    }, 100);
                }

                // Check if font is loaded and draw banner
                function checkFontAndDraw() {
                    if ('fonts' in document) {
                        // console.log('[checkFontAndDraw] Font Loading API available. Waiting for document.fonts.ready...');
                        document.fonts.ready.then(() => {
                            document.fonts.load('56px "Playpen Sans"').then((loadedFonts) => {
                                // console.log('[checkFontAndDraw] document.fonts.load resolved:', loadedFonts);
                                drawBanner();
                                setTimeout(() => {
                                    drawBanner();
                                }, 200);
                            }).catch((err) => {
                                // console.warn('[checkFontAndDraw] document.fonts.load failed:', err);
                                setTimeout(() => {
                                    drawBanner();
                                }, 500);
                            });
                        });
                    } else {
                        // console.warn('[checkFontAndDraw] Font Loading API not available, using fallback.');
                        setTimeout(() => {
                            drawBanner();
                        }, 500);
                    }
                }

                template.onload = () => {
                    checkFontAndDraw();
                };

                // If image is already loaded, trigger checkFontAndDraw directly
                if (template.complete) {
                    checkFontAndDraw();
                }
            }

            // Download banner functionality
            document.getElementById('downloadBanner').addEventListener('click', () => {
                const canvas = document.getElementById('bannerCanvas');
                const link = document.createElement('a');
                link.download = 'stagona-banner.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            });

            // Modal functionality
            const modal = document.getElementById("aboutModal");
            const infoButton = document.getElementById("infoButton");
            const modalClose = document.getElementById("modalClose");

            function openModal(modalElement) {
                modalElement.style.display = "flex";
                document.body.style.overflow = "hidden";
            }

            function closeModal(modalElement) {
                modalElement.style.display = "none";
                document.body.style.overflow = "auto";
            }

            // Make modal functions globally available
            window.openModal = openModal;
            window.closeModal = closeModal;

            infoButton.onclick = () => {
                openModal(modal);
            };

            modalClose.onclick = () => {
                closeModal(modal);
            };

            window.onclick = (event) => {
                if (event.target === modal) {
                    closeModal(modal);
                }
            };

            // Notice Modal functionality
            const noticeModal = document.getElementById("noticeModal");
            const noticeModalClose = document.getElementById("noticeModalClose");
            const noticeModalButton = document.getElementById("noticeModalButton");
            const noticeModalMessage = document.getElementById("noticeModalMessage");

            function showNotice(message) {
                noticeModalMessage.textContent = message;
                openModal(noticeModal);
            }

            function hideNotice() {
                closeModal(noticeModal);
            }

            noticeModalClose.onclick = hideNotice;
            noticeModalButton.onclick = hideNotice;
            noticeModal.onclick = (event) => {
                if (event.target === noticeModal) {
                    hideNotice();
                }
            };

            // Add translations for the email copied message
            translations.el["email-copied"] = "Œ§Œø email Œ±ŒΩœÑŒπŒ≥œÅŒ¨œÜŒ∑Œ∫Œµ!";
            translations.en["email-copied"] = "Email copied!";

            // Add email copy functionality with error handling
            document.getElementById('contactEmail').addEventListener('click', function(e) {
                e.preventDefault();
                const email = this.textContent;
                navigator.clipboard.writeText(email)
                    .then(() => {
                        showNotice(translations[currentLang]["email-copied"]);
                    })
                    .catch(err => {
                        console.error('Failed to copy email:', err);
                        showNotice(currentLang === "el" ? "ŒëœÄŒøœÑœÖœáŒØŒ± Œ±ŒΩœÑŒπŒ≥œÅŒ±œÜŒÆœÇ email" : "Failed to copy email");
                    });
            });



            // Example modal functionality
            const exampleModal = document.getElementById('exampleModal');
            const exampleModalClose = document.getElementById('exampleModalClose');

            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('example-link')) {
                    e.preventDefault();
                    openModal(exampleModal);
                }
                if (e.target.classList.contains('why-info-link')) {
                    e.preventDefault();
                    openModal(whyInfoModal);
                }
                if (e.target.classList.contains('tips-modal-link')) {
                    e.preventDefault();
                    openModal(tipsModal);
                }
            });

            exampleModalClose.onclick = () => {
                closeModal(exampleModal);
            };

            exampleModal.onclick = (event) => {
                if (event.target === exampleModal) {
                    closeModal(exampleModal);
                }
            };

            // Initialize the page in Greek
            updateLanguage("el");

            // Tips Modal functionality
            const tipsModal = document.getElementById('tipsModal');
            const tipsModalClose = document.getElementById('tipsModalClose');
            const tipsButton = document.getElementById('tipsButton');
            if (tipsButton) {
                tipsButton.onclick = () => {
                    openModal(tipsModal);
                };
            }
            tipsModalClose.onclick = () => {
                closeModal(tipsModal);
            };
            tipsModal.onclick = (event) => {
                if (event.target === tipsModal) {
                    closeModal(tipsModal);
                }
            };

            // Reminder Button functionality
            const reminderButton = document.getElementById('reminderButton');
            if (reminderButton) {
                reminderButton.onclick = () => {
                    // Calculate date in one month
                    const oneMonthFromNow = new Date();
                    oneMonthFromNow.setMonth(oneMonthFromNow.getMonth() + 1);

                    // Format date for calendar (all-day event)
                    const year = oneMonthFromNow.getFullYear();
                    const month = String(oneMonthFromNow.getMonth() + 1).padStart(2, '0');
                    const day = String(oneMonthFromNow.getDate()).padStart(2, '0');

                    const startDate = `${year}${month}${day}`;
                    const endDate = `${year}${month}${day}`;

                    // Create event details
                    const eventTitle = currentLang === 'el' ? 'Stagona.cy: ŒàŒªŒµŒ≥œáŒøœÇ Œ∫Œ±œÑŒ±ŒΩŒ¨ŒªœâœÉŒ∑œÇ ŒΩŒµœÅŒøœç #Cyprus125' : 'Stagona.cy: Water consumption check #Cyprus125';
                    const eventDescription = currentLang === 'el' ?
                        '<b>ŒöŒ±œÑŒ¨Œ≥œÅŒ±œàŒµ œÑŒ∑ŒΩ Œ∫Œ±œÑŒ±ŒΩŒ¨ŒªœâœÉŒ∑ œÑŒøœÖ ŒºŒµœÑœÅŒ∑œÑŒÆ œÉŒøœÖ:</b><br>ŒàŒªŒµŒ≥ŒæŒµ ŒæŒ±ŒΩŒ¨ œÑŒ∑ŒΩ Œ∫Œ±œÑŒ±ŒΩŒ¨ŒªœâœÉŒ∑ ŒΩŒµœÅŒøœç œÉŒøœÖ œÉœÑŒø Stagona App: https://stagona.cy' :
                        '<b>Record your water consumption:</b><br>Check your water consumption again on Stagona App: https://stagona.cy';

                    // Create calendar URL for all-day event
                    const calendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(eventTitle)}&details=${encodeURIComponent(eventDescription)}&dates=${startDate}/${endDate}&sf=true`;

                    // Open calendar in new tab
                    window.open(calendarUrl, '_blank');

                    // Show success message
                    const successMsg = currentLang === 'el' ?
                        'Œó œÖœÄŒµŒΩŒ∏œçŒºŒπœÉŒ∑ œÄœÅŒøœÉœÑŒ≠Œ∏Œ∑Œ∫Œµ œÉœÑŒøŒΩ Œ∑ŒºŒµœÅŒøŒªœåŒ≥ŒπŒø œÉŒ±œÇ. ŒúŒ∑ ŒæŒµœáŒ¨œÉŒµœÑŒµ ŒΩŒ± Œ∫Œ±œÑŒ±Œ≥œÅŒ¨œàœÑŒµ œÑŒ∑ŒΩ Œ≠ŒΩŒ¥ŒµŒπŒæŒ∑ œÑŒøœÖ ŒºŒµœÑœÅŒ∑œÑŒÆ ŒΩŒµœÅŒøœç œÉŒ±œÇ œÉŒÆŒºŒµœÅŒ±.' :
                        'Reminder added to your calendar. Don\'t forget to record your water meter reading today.';
                    showNotice(successMsg);
                };
            }

            // Water Stress Info Modal functionality
            const stressInfoModal = document.getElementById('stressInfoModal');
            const stressInfoModalClose = document.getElementById('stressInfoModalClose');
            const stressInfoButton = document.getElementById('stressInfo');

            if (stressInfoButton) {
                stressInfoButton.onclick = () => {
                    openModal(stressInfoModal);
                };
            }

            stressInfoModalClose.onclick = () => {
                closeModal(stressInfoModal);
            };

            stressInfoModal.onclick = (event) => {
                if (event.target === stressInfoModal) {
                    closeModal(stressInfoModal);
                }
            };

            // Action Info Modal functionality
            const actionInfoModal = document.getElementById('actionInfoModal');
            const actionInfoModalClose = document.getElementById('actionInfoModalClose');
            const actionInfoButton = document.getElementById('actionInfo');

            if (actionInfoButton) {
                actionInfoButton.onclick = () => {
                    openModal(actionInfoModal);
                };
            }

            actionInfoModalClose.onclick = () => {
                closeModal(actionInfoModal);
            };

            actionInfoModal.onclick = (event) => {
                if (event.target === actionInfoModal) {
                    closeModal(actionInfoModal);
                }
            };

            // Why Info Modal functionality
            const whyInfoModal = document.getElementById('whyInfoModal');
            const whyInfoModalClose = document.getElementById('whyInfoModalClose');
            const whyInfoButton = document.getElementById('whyInfo');

            if (whyInfoButton) {
                whyInfoButton.onclick = () => {
                    openModal(whyInfoModal);
                };
            }

            whyInfoModalClose.onclick = () => {
                closeModal(whyInfoModal);
            };

            whyInfoModal.onclick = (event) => {
                if (event.target === whyInfoModal) {
                    closeModal(whyInfoModal);
                }
            };

            // Add translations for the pledge slider label
            translations.el["pledge-label"] = "ŒòŒ± œÄœÅŒøœÉœÄŒ±Œ∏ŒÆœÉœâ ŒΩŒ± ŒºŒµŒπœéœÉœâ œÑŒ∑ŒΩ Œ∫Œ±œÑŒ±ŒΩŒ¨ŒªœâœÉŒ∑ ŒΩŒµœÅŒøœç Œ∫Œ±œÑŒ¨:";
            translations.en["pledge-label"] = "I pledge to reduce my water usage by:";

            // Pledge slider logic
            function updatePledgeLabel() {
                const label = document.getElementById("pledgeSliderLabel");
                if (label) {
                    const slider = document.getElementById("pledgeSlider");
                    const percent = slider ? parseInt(slider.value, 10) : 10;

                    // Calculate liters from current result
                    let perDay = 140;
                    const resultValueElem = document.querySelector('.result-value');
                    if (resultValueElem) {
                        const match = resultValueElem.textContent.match(/([\d.]+)/);
                        if (match) {
                            perDay = parseFloat(match[1]);
                        }
                    }

                    const newLiters = (perDay * (1 - percent / 100)).toFixed(1);
                    const unit = currentLang === "el" ? "ŒªŒØœÑœÅŒ±" : "liters";
                    label.innerHTML = `${translations[currentLang]["pledge-label"]} <span id='pledgeValue'>${percent}%</span> (${newLiters} ${unit})`;
                }
            }

            // Initialize pledge slider
            const pledgeSlider = document.getElementById("pledgeSlider");
            if (pledgeSlider) {
                updatePledgeLabel();
                pledgeSlider.addEventListener("input", function() {
                    updatePledgeLabel();
                    updateResultSummary();
                });
            }

            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('js/sw.js')
                    .then(() => console.log('SW registered'))
                    .catch(console.error);
            }

            // Function to update result message based on current values and language
            function updateResultMessage() {
                const msgElem = document.getElementById("resultMessage");
                if (!msgElem) return;

                // Get current calculation values
                const totalM3 = parseFloat(document.getElementById("total").value);
                const months = parseInt(document.getElementById("period").value);
                const people = parseInt(document.getElementById("people").value);

                if (totalM3 <= 0 || months <= 0 || people <= 0) return;

                const totalLitres = totalM3 * 1000;
                const days = months * 30.4;
                const perDay = totalLitres / days / people;
                const avg = 140;
                const diffPct = ((perDay - avg) / avg) * 100;

                // Update result message based on difference percentage
                let msg = "";
                if (diffPct < -20) {
                    msg = translations[currentLang]["result-excellent"] + "<br/><br/>" + translations[currentLang]["result-excellent-desc"];
                } else if (diffPct >= -20 && diffPct < -10) {
                    msg = translations[currentLang]["result-good"] + "<br/><br/>" + translations[currentLang]["result-good-desc"];
                } else if (diffPct >= -10 && diffPct < 0) {
                    msg = translations[currentLang]["result-average"] + "<br/><br/>" + translations[currentLang]["result-average-desc"];
                } else if (diffPct >= 0 && diffPct < 10) {
                    msg = translations[currentLang]["result-slightly-high"] + "<br/><br/>" + translations[currentLang]["result-slightly-high-desc"];
                } else if (diffPct >= 10 && diffPct < 20) {
                    msg = translations[currentLang]["result-high"] + "<br/><br/>" + translations[currentLang]["result-high-desc"];
                } else {
                    msg = translations[currentLang]["result-very-high"] + "<br/><br/>" + translations[currentLang]["result-very-high-desc"];
                }
                msgElem.innerHTML = msg;
            }

            // Enforce max values for people and total inputs
            const peopleInput = document.getElementById('people');
            const totalInput = document.getElementById('total');
            if (peopleInput) {
                peopleInput.addEventListener('input', function() {
                    if (parseInt(this.value, 10) > 15) this.value = 15;
                });
            }
            if (totalInput) {
                totalInput.addEventListener('input', function() {
                    if (parseFloat(this.value) > 500) this.value = 500;
                });
            }
        });
    </script>
    <!-- Start Open Web Analytics Tracker -->
    <script type="text/javascript">
        //<![CDATA[
        var owa_baseUrl = 'https://kiosapps.ucy.ac.cy/owa/';
        var owa_cmds = owa_cmds || [];
        owa_cmds.push(['setSiteId', 'f2cb5869bdf791aab90adc79b7f0671a']);
        owa_cmds.push(['trackPageView']);
        owa_cmds.push(['trackClicks']);

        (function() {
            var _owa = document.createElement('script');
            _owa.type = 'text/javascript';
            _owa.async = true;
            owa_baseUrl = ('https:' == document.location.protocol ? window.owa_baseSecUrl || owa_baseUrl.replace(/http:/, 'https:') : owa_baseUrl);
            _owa.src = owa_baseUrl + 'modules/base/js/owa.tracker-combined-min.js';
            var _owa_s = document.getElementsByTagName('script')[0];
            _owa_s.parentNode.insertBefore(_owa, _owa_s);
        }());
        //]]>
    </script>
    <!-- End Open Web Analytics Code -->
</body>

</html>